// ChatPage.ets
import { ChatService } from '../service/ChatService';
import {ChatMessage} from '../viewmodel/ChatMessage'
import promptAction from '@ohos.promptAction';
import { BusinessError } from '@kit.BasicServicesKit';
import router from '@ohos.router';
import { MessageStorage } from '../model/MessageStorage';
import common from '@ohos.app.ability.common';

@Entry
@Component
struct ChatPage {
  @State messages: ChatMessage[] = [];
  @State inputText: string = '';
  @State isConnected: boolean = false;
  @State serverAddress: string = '10.0.2.2'; // æ¨¡æ‹Ÿå™¨é»˜è®¤è¿æ¥ä¸»æœºçš„IP
  @State serverPort: number = 8080;
  @State loadingStatus: string = '';
  @State isTyping: boolean = false;
  private selfs: boolean[] = []
  private chatService: ChatService = new ChatService();
  private scroller: Scroller = new Scroller();
  // å¤´åƒèµ„æºæ± 
  private avatarPool: Resource[] = [
    $r('app.media.userA'),
    $r('app.media.userB'),
    $r('app.media.userC'),
    $r('app.media.userD')
  ];
  // ç”¨æˆ·å¤´åƒæ˜ å°„è¡¨
  private userAvatars: Map<string, Resource> = new Map();
  // å·²ä½¿ç”¨çš„å¤´åƒç´¢å¼•
  private usedAvatarIndices: Set<number> = new Set();
  // ä½¿ç”¨ç°æœ‰çš„å¤´åƒèµ„æº
  private defaultAvatar: Resource = $r('app.media.avatar_1');
  private selfAvatar: Resource = $r('app.media.avatar_2');

  // è·å–ç”¨æˆ·å¤´åƒ
  private getUserAvatar(sender: number | string | undefined): Resource {
    if (sender === undefined) {
      return this.selfAvatar;
    }

    // å°†senderè½¬æ¢ä¸ºå­—ç¬¦ä¸²ä½œä¸ºkey
    const senderKey = sender.toString();

    // å¦‚æœç”¨æˆ·å·²ç»æœ‰å¤´åƒï¼Œç›´æ¥è¿”å›
    const existingAvatar = this.userAvatars.get(senderKey);
    if (existingAvatar !== undefined) {
      return existingAvatar;
    }

    // è·å–ä¸€ä¸ªæœªä½¿ç”¨çš„å¤´åƒ
    let availableIndices: number[] = [];
    for (let i = 0; i < this.avatarPool.length; i++) {
      if (!this.usedAvatarIndices.has(i)) {
        availableIndices.push(i);
      }
    }

    // å¦‚æœæ‰€æœ‰å¤´åƒéƒ½è¢«ä½¿ç”¨äº†ï¼Œé‡ç½®ä½¿ç”¨çŠ¶æ€
    if (availableIndices.length === 0) {
      this.usedAvatarIndices.clear();
      availableIndices = [];
      for (let i = 0; i < this.avatarPool.length; i++) {
        availableIndices.push(i);
      }
    }

    // éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨å¤´åƒ
    const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
    const selectedAvatar = this.avatarPool[randomIndex];

    // è®°å½•ä½¿ç”¨æƒ…å†µ
    this.usedAvatarIndices.add(randomIndex);
    this.userAvatars.set(senderKey, selectedAvatar);

    return selectedAvatar;
  }

  async aboutToAppear() {
    // è®¾ç½® MessageStorage çš„ä¸Šä¸‹æ–‡
    MessageStorage.setContext(getContext(this) as common.UIAbilityContext);

    // åŠ è½½ä¿å­˜çš„æ¶ˆæ¯
    const savedMessages = await MessageStorage.getMessages();
    this.messages = savedMessages;
    // åˆå§‹åŒ–selfsæ•°ç»„
    this.selfs = savedMessages.map(msg => msg.sender === undefined);

    // ç›‘å¬æ¶ˆæ¯æ¥æ”¶äº‹ä»¶
    this.chatService.onMessage((message: ChatMessage) => {
      this.messages.push(message);
      this.selfs.push(message.sender === undefined);
      // ä¿å­˜æ¶ˆæ¯
      MessageStorage.saveMessages(this.messages);
      // ä¿è¯UIæ›´æ–°åæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
      setTimeout(() => {
        this.scroller.scrollToIndex(this.messages.length - 1);
      }, 100);
    });

    // ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
    this.chatService.onConnect(() => {
      this.isConnected = true;
      this.loadingStatus = '';

      // æ·»åŠ è¿æ¥æˆåŠŸæ¶ˆæ¯
      promptAction.showToast({
        message: 'å·²è¿æ¥åˆ°æœåŠ¡å™¨',
        duration: 2000
      });
    });

    this.chatService.onDisconnect(() => {
      this.isConnected = false;

      // æ·»åŠ æ–­å¼€è¿æ¥æ¶ˆæ¯
      this.messages.push({
        type: 'system',
        content: 'å·²æ–­å¼€ä¸æœåŠ¡å™¨çš„è¿æ¥'
      });
      // ä¿å­˜æ¶ˆæ¯
      MessageStorage.saveMessages(this.messages);

      promptAction.showToast({
        message: 'å·²æ–­å¼€è¿æ¥',
        duration: 2000
      });
    });

    this.chatService.onError((error) => {
      this.loadingStatus = '';
      promptAction.showToast({
        message: 'å‘ç”Ÿé”™è¯¯: ' + error.message,
        duration: 3000
      });
    });
  }

  // è¿æ¥æœåŠ¡å™¨
  async connectToServer() {
    if (this.isConnected) {
      return;
    }

    this.loadingStatus = 'æ­£åœ¨è¿æ¥...';

    try {
      await this.chatService.connect(this.serverAddress, this.serverPort);
      // è¿æ¥æˆåŠŸçš„å¤„ç†å·²ç»åœ¨ onConnect å›è°ƒä¸­å¤„ç†
    } catch (error) {
      this.loadingStatus = '';
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      promptAction.showDialog({
        title: 'è¿æ¥å¤±è´¥',
        message: errorMessage,
        buttons: [
          {
            text: 'ç¡®å®š',
            color: '#0000ff',
          }
        ]
      });
    }
  }

  // æ–­å¼€è¿æ¥
  async disconnectFromServer() {
    if (!this.isConnected) {
      return;
    }

    try {
      await this.chatService.disconnect();
      // æ–­å¼€è¿æ¥åæ¸…é™¤æ¶ˆæ¯
      await MessageStorage.clearMessages();
      this.messages = [];
      this.selfs = [];
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      promptAction.showToast({
        message: 'æ–­å¼€è¿æ¥å¤±è´¥: ' + errorMessage,
        duration: 3000
      });
    }
  }

  // å‘é€æ¶ˆæ¯
  async sendMessage() {
    if (!this.inputText.trim() || !this.isConnected) {
      return;
    }

    try {
      await this.chatService.sendMessage(this.inputText.trim());
      // æ¸…ç©ºè¾“å…¥æ¡†
      this.inputText = '';
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      promptAction.showToast({
        message: 'å‘é€æ¶ˆæ¯å¤±è´¥: ' + errorMessage,
        duration: 3000
      });
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        // è¿”å›æŒ‰é’®
        Row() {
          // Text('â†')
          //   .fontSize(28)
          //   .fontWeight(FontWeight.Bold)
          //   .fontColor('#333333')
          //   .margin({ right: 16 })
          //   .onClick(() => {router.back()})
          Row() {
            Text('ğŸ’¬')
              .fontSize(24)
              .margin({ right: 12 })
              .onClick(() => {router.back()})
            Text('å®æ—¶èŠå¤©')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
          }
          .alignItems(VerticalAlign.Center)
        }
        .alignItems(VerticalAlign.Center)

        Blank()
        if (this.loadingStatus) {
          Row() {
            LoadingProgress()
              .width(16)
              .height(16)
              .margin({ right: 8 })
            Text(this.loadingStatus)
              .fontSize(14)
              .fontColor('#666666')
          }
        } else {
          Row() {
            Circle()
              .width(8)
              .height(8)
              .fill(this.isConnected ? '#4CAF50' : '#FF5252')
              .margin({ right: 6 })
            Text(this.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥')
              .fontSize(14)
              .fontColor(this.isConnected ? '#4CAF50' : '#FF5252')
          }
        }
      }
      .width('100%')
      .height(64)
      .padding({ left: 20, right: 20 })
      .backgroundColor('#1A1A1A')
      .shadow({ radius: 8, color: '#1A000000', offsetY: 2 })

      // æœåŠ¡å™¨è®¾ç½®
      Column() {
        Row() {
          Text('æœåŠ¡å™¨:').fontSize(16).fontColor('#FFFFFF')
          TextInput({ text: this.serverAddress })
            .width('30%')
            .height(40)
            .margin({ left: 8, right: 8 })
            .backgroundColor('#2A2A2A')
            .borderRadius(8)
            .padding({ left: 12, right: 12 })
            .fontColor('#FFFFFF')
            .onChange((value) => {
              this.serverAddress = value;
            })
          Text('ç«¯å£:').fontSize(16).fontColor('#FFFFFF')
          TextInput({ text: this.serverPort.toString() })
            .width('30%')
            .height(40)
            .margin({ left: 8 })
            .backgroundColor('#2A2A2A')
            .borderRadius(8)
            .padding({ left: 12, right: 12 })
            .fontColor('#FFFFFF')
            .onChange((value) => {
              this.serverPort = parseInt(value);
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 16 })
        .backgroundColor('#1A1A1A')

        Button(this.isConnected ? 'æ–­å¼€è¿æ¥' : 'è¿æ¥æœåŠ¡å™¨')
          .width('90%')
          .height(48)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .borderRadius(24)
          .backgroundColor(this.isConnected ? '#FF5252' : '#4CAF50')
          .onClick(() => {
            if (this.isConnected) {
              this.disconnectFromServer();
            } else {
              this.connectToServer();
            }
          })
          .margin({ bottom: 16 })
      }
      .width('100%')
      .backgroundColor('#1A1A1A')

      // æ¶ˆæ¯åˆ—è¡¨
      List({ scroller: this.scroller }) {
        ForEach(this.messages, (message: ChatMessage, index) => {
          ListItem() {
            this.MessageBubble(message, index)
          }
        }, (message: ChatMessage, index) => index.toString())
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor('#1A1A1A')

      // è¾“å…¥åŒºåŸŸ
      Column() {
        if (this.isTyping) {
          Text('å¯¹æ–¹æ­£åœ¨è¾“å…¥...')
            .fontSize(12)
            .fontColor('#999999')
            .margin({ left: 16, bottom: 4 })
        }

        Row() {
          TextInput({
            placeholder: 'è¾“å…¥æ¶ˆæ¯...',
            text: this.inputText
          })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#2A2A2A')
            .borderRadius(24)
            .padding({ left: 20, right: 20 })
            .placeholderColor('#999999')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .onChange((value) => {
              this.inputText = value;
              this.isTyping = value.length > 0;
            })
            .onSubmit(() => {
              this.sendMessage();
              return true;
            })

          Button('å‘é€')
            .height(48)
            .width(80)
            .margin({ left: 12 })
            .borderRadius(24)
            .backgroundColor('#4CAF50')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .onClick(() => {
              this.sendMessage();
            })
            .enabled(this.isConnected && this.inputText.trim().length > 0)
            .opacity(this.isConnected && this.inputText.trim().length > 0 ? 1.0 : 0.5)
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#1A1A1A')
      .shadow({ radius: 8, color: '#1A000000', offsetY: -2 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1A1A1A')
  }

  @Builder
  MessageBubble(message: ChatMessage, index: number) {
    if (message.type === 'system') {
      // ç³»ç»Ÿæ¶ˆæ¯å±…ä¸­æ˜¾ç¤º
      Text(message.content)
        .fontSize(14)
        .fontColor('#CCCCCC')
        .maxLines(10)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .textAlign(TextAlign.Center)
        .width('90%')
        .padding(12)
        .margin({ top: 8, bottom: 8 })
        .borderRadius(16)
        .backgroundColor('#2A2A2A')
    } else {
      Row() {
        if (!this.selfs[index]) {
          // æ¥æ”¶è€…å¤´åƒ
          Image(this.getUserAvatar(message.sender))
            .width(40)
            .height(40)
            .borderRadius(20)
            .margin({ right: 8 })
            .objectFit(ImageFit.Cover)
        }

        Column() {
          if (!this.selfs[index] && message.sender !== undefined) {
            Text(`ç”¨æˆ· ${message.sender}`)
              .fontSize(12)
              .fontColor('#CCCCCC')
              .alignSelf(this.selfs[index] ? ItemAlign.End : ItemAlign.Start)
              .margin({ bottom: 4 })
          }

          Text(message.content)
            .fontSize(16)
            .maxLines(100)
            .padding(16)
            .borderRadius(20)
            .backgroundColor(this.selfs[index] ? '#4CAF50' : '#2A2A2A')
            .fontColor(this.selfs[index] ? '#FFFFFF' : '#FFFFFF')
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .shadow({ radius: 4, color: '#1A000000', offsetY: 2 })
        }
        .alignItems(this.selfs[index] ? HorizontalAlign.End : HorizontalAlign.Start)
        .width('70%')

        if (this.selfs[index]) {
          // å‘é€è€…å¤´åƒ
          Image(this.selfAvatar)
            .width(40)
            .height(40)
            .borderRadius(20)
            .margin({ left: 8 })
            .objectFit(ImageFit.Cover)
        }
      }
      .width('100%')
      .margin({ top: 12, bottom: 12 })
      .justifyContent(this.selfs[index] ? FlexAlign.End : FlexAlign.Start)
      .alignItems(VerticalAlign.Top)
    }
  }
}